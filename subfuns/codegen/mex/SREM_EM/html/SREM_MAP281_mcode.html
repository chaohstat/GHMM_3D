<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="69,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T11U3">b0</span>, <span class="var type1" id="S3T55U4">Pb</span>, <span class="var type1" id="S4T1U5">sum_U</span>] = SREM_MAP(<span class="var type1" id="S5T11U8">b</span>,<span class="var type1" id="S6T11U9">Y</span>,<span class="var type1" id="S7T16U10">DIC</span>,<span class="var type1" id="S8T72U11">W0</span>,<span class="var type1" id="S9T13U12">beta</span>,<span class="var type1" id="S10T74U13">exbetabar</span>,<span class="var type1" id="S11T39U14">Sigma_s</span>,<span class="var type1" id="S12T1U15">tau</span>,<span class="var type1" id="S13T1U16">MAP_iter</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="69,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%%  The EM algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%---input---------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%   b: initial 2D or 3D labels p*n</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%   Y1: image intensity matrix p*m</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%   DIC: dictionary of spatial relationship</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">%   subind: subject information m*3</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%   beta: initial value of beta q*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">%   betabar: initial value of betabar q*2</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,10" id="srcline10">10</a></span><span class="line"><span class="comment">%   Sigma_s: initial value of variance matrix in epsilon 1*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,11" id="srcline11">11</a></span><span class="line"><span class="comment">%   tau: initial value of tau in Gibbs distribution 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,12" id="srcline12">12</a></span><span class="line"><span class="comment">%   MAP_iter: maximum number of iterations of the MAP algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,13" id="srcline13">13</a></span><span class="line"><span class="comment">%---output--------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,14" id="srcline14">14</a></span><span class="line"><span class="comment">%   b0: final 2D or 3D labels</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,16" id="srcline16">16</a></span><span class="line"><span class="comment">%   Copyright by Chao Huang, 2015/01/25</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,17" id="srcline17">17</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo " id="T1:U13">[<span class="var type1" id="S14T1U20">m</span>,<span class="var type1" id="S15T1U21">N0</span>] = size(<span class="var type1" id="S6T11U24">Y</span>)</span>; <span class="mxinfo " id="T12:U17"><span class="var type1" id="S17T12U27">sum_U_MAP</span> = <span class="mxinfo " id="T12:U19">zeros(<span class="mxinfo " id="T1:U20">1</span>,<span class="var type1" id="S13T1U31">MAP_iter</span>)</span></span>; <span class="mxinfo " id="T79:U22"><span class="var type1" id="S19T79U34">cri</span> = <span class="mxinfo " id="T79:U24">zeros(<span class="var type1" id="S15T1U37">N0</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T49:U26"><span class="var type1" id="S20T49U41">U0</span> = <span class="mxinfo " id="T49:U28">zeros(<span class="var type1" id="S14T1U44">m</span>,<span class="mxinfo " id="T1:U30">3</span>,<span class="var type1" id="S15T1U46">N0</span>)</span></span>; <span class="mxinfo " id="T49:U32"><span class="var type1" id="S21T49U49">U1</span> = <span class="mxinfo " id="T49:U34">zeros(<span class="var type1" id="S14T1U52">m</span>,<span class="mxinfo " id="T1:U36">3</span>,<span class="var type1" id="S15T1U54">N0</span>)</span></span>; <span class="mxinfo " id="T49:U38"><span class="var type1" id="S22T49U57">U</span> = <span class="mxinfo " id="T49:U40">zeros(<span class="var type1" id="S14T1U60">m</span>,<span class="mxinfo " id="T1:U42">3</span>,<span class="var type1" id="S15T1U62">N0</span>)</span></span>; <span class="mxinfo " id="T55:U44"><span class="var type1" id="S3T55U65">Pb</span> = <span class="mxinfo " id="T55:U46">zeros(<span class="mxinfo " id="T1:U47">3</span>,<span class="var type1" id="S15T1U69">N0</span>,<span class="var type1" id="S14T1U70">m</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T80:U50"><span class="var type1" id="S23T80U73">indd</span> = <span class="mxinfo " id="T80:U52">find(<span class="mxinfo " id="T75:U53"><span class="var type1" id="S7T16U77">DIC</span>~=<span class="mxinfo " id="T1:U55">0</span></span>)</span></span>; <span class="mxinfo " id="T80:U56"><span class="var type1" id="S25T80U81">nozeroind</span> = <span class="mxinfo " id="T80:U58"><span class="var type1" id="S7T16U83">DIC</span>(<span class="var type1" id="S23T80U84">indd</span>)</span></span>; <span class="mxinfo " id="T16:U61"><span class="var type1" id="S26T16U87">Ymat</span> = <span class="mxinfo " id="T16:U63">zeros(<span class="mxinfo " id="T33:U64">size(<span class="var type1" id="S7T16U92">DIC</span>)</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="69,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo " id="T16:U66"><span class="var type1" id="S27T16U95">bmat</span> = <span class="mxinfo " id="T16:U68">zeros(<span class="mxinfo " id="T33:U69">size(<span class="var type1" id="S7T16U100">DIC</span>)</span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="69,23" id="srcline23">23</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S28T1U103">ii</span> = <span class="mxinfo " id="T1:U72">1</span>:<span class="var type1" id="S15T1U106">N0</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,24" id="srcline24">24</a></span><span class="line">    <span class="mxinfo " id="T76:U74"><span class="var type1" id="S29T76U109">Yii</span> = <span class="mxinfo " id="T76:U76"><span class="var type1" id="S6T11U111">Y</span>(:,<span class="var type1" id="S28T1U113">ii</span>)</span></span>; <span class="mxinfo " id="T80:U79"><span class="mxinfo " id="T80:U80"><span class="var type1" id="S26T16U117">Ymat</span>(<span class="var type1" id="S23T80U118">indd</span>)</span> = <span class="mxinfo " id="T80:U83"><span class="var type1" id="S29T76U120">Yii</span>(<span class="var type1" id="S25T80U121">nozeroind</span>)</span></span>; <span class="mxinfo " id="T16:U86"><span class="var type1" id="S30T16U124">W</span> = <span class="mxinfo " id="T16:U88">exp(<span class="mxinfo " id="T16:U89"><span class="mxinfo " id="T1:U90">-0.5</span>*<span class="mxinfo " id="T16:U91">abs(<span class="mxinfo " id="T16:U92"><span class="var type1" id="S26T16U133">Ymat</span>-<span class="mxinfo " id="T85:U94"><span class="var type1" id="S29T76U135">Yii</span>*<span class="mxinfo " id="T94:U96">ones(<span class="mxinfo " id="T1:U97">1</span>,<span class="mxinfo " id="T1:U98">length(<span class="mxinfo " id="T94:U99"><span class="var type1" id="S7T16U142">DIC</span>(<span class="mxinfo " id="T1:U101">1</span>,:)</span>)</span>)</span></span></span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,25" id="srcline25">25</a></span><span class="line">    <span class="mxinfo " id="T76:U102"><span class="var type1" id="S35T76U147">Yres</span> = <span class="mxinfo " id="T76:U104"><span class="var type1" id="S29T76U149">Yii</span>-<span class="mxinfo " id="T76:U106">(<span class="mxinfo " id="T39:U107"><span class="mxinfo " id="T84:U108"><span class="mxinfo " id="T93:U109"><span class="var type1" id="S8T72U155">W0</span>(:,<span class="var type1" id="S28T1U157">ii</span>)</span>'</span>*<span class="var type1" id="S9T13U158">beta</span></span>)'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,26" id="srcline26">26</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S36T1U161">ll</span> = <span class="mxinfo " id="T1:U114">1</span>:<span class="var type1" id="S13T1U164">MAP_iter</span> </span></span>
<span class="srcline"><span class="lineno"><a href="69,27" id="srcline27">27</a></span><span class="line">        <span class="mxinfo " id="T86:U116"><span class="mxinfo " id="T86:U117"><span class="var type1" id="S20T49U168">U0</span>(:,:,<span class="var type1" id="S28T1U171">ii</span>)</span> = <span class="mxinfo " id="T86:U120"><span class="mxinfo " id="T86:U121"><span class="mxinfo " id="T86:U122"><span class="mxinfo " id="T76:U123"><span class="mxinfo " id="T76:U124"><span class="mxinfo " id="T1:U125">0.5</span>*<span class="mxinfo " id="T76:U126"><span class="var type1" id="S35T76U179">Yres</span>.^2</span></span>./(<span class="mxinfo " id="T76:U128"><span class="var type1" id="S11T39U183">Sigma_s</span>'</span>)</span>*<span class="mxinfo " id="T48:U130">ones(1,3)</span></span>-<span class="mxinfo " id="T86:U131"><span class="mxinfo " id="T85:U132"><span class="mxinfo " id="T76:U133"><span class="var type1" id="S35T76U191">Yres</span>./(<span class="mxinfo " id="T76:U135"><span class="var type1" id="S11T39U194">Sigma_s</span>'</span>)</span>*<span class="mxinfo " id="T84:U137"><span class="mxinfo " id="T93:U138"><span class="var type1" id="S8T72U197">W0</span>(:,<span class="var type1" id="S28T1U199">ii</span>)</span>'</span></span>*<span class="var type1" id="S10T74U200">exbetabar</span></span></span>+<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="69,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo " id="T86:U116"><span class="mxinfo " id="T86:U120">                    <span class="mxinfo " id="T86:U142"><span class="mxinfo " id="T76:U143"><span class="mxinfo " id="T1:U144">0.5</span>./(<span class="mxinfo " id="T76:U145"><span class="var type1" id="S11T39U206">Sigma_s</span>'</span>)</span>*<span class="mxinfo " id="T48:U147">(<span class="mxinfo " id="T48:U148"><span class="mxinfo " id="T84:U149"><span class="mxinfo " id="T93:U150"><span class="var type1" id="S8T72U212">W0</span>(:,<span class="var type1" id="S28T1U214">ii</span>)</span>'</span>*<span class="var type1" id="S10T74U215">exbetabar</span></span>).^2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,29" id="srcline29">29</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S37T1U219">kk</span> = <span class="mxinfo " id="T1:U155">1</span>:3</span></span>
<span class="srcline"><span class="lineno"><a href="69,30" id="srcline30">30</a></span><span class="line">            <span class="mxinfo " id="T16:U156"><span class="var type1" id="S38T16U225">bindd</span> = <span class="mxinfo " id="T16:U158">real(<span class="mxinfo " id="T75:U159"><span class="var type1" id="S27T16U229">bmat</span>==<span class="var type1" id="S37T1U230">kk</span></span>)</span></span>; <span class="mxinfo " id="T76:U162"><span class="mxinfo " id="T76:U163"><span class="var type1" id="S21T49U234">U1</span>(:,<span class="var type1" id="S37T1U236">kk</span>,<span class="var type1" id="S28T1U237">ii</span>)</span> = <span class="mxinfo " id="T76:U167"><span class="mxinfo " id="T76:U168">-<span class="mxinfo " id="T76:U169">sum(<span class="mxinfo " id="T16:U170"><span class="var type1" id="S38T16U243">bindd</span>.*<span class="var type1" id="S30T16U244">W</span></span>,2)</span></span>*<span class="var type1" id="S12T1U246">tau</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,31" id="srcline31">31</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,32" id="srcline32">32</a></span><span class="line">        <span class="mxinfo " id="T86:U174"><span class="mxinfo " id="T86:U175"><span class="var type1" id="S22T49U250">U</span>(:,:,<span class="var type1" id="S28T1U253">ii</span>)</span>=<span class="mxinfo " id="T86:U178"><span class="mxinfo " id="T86:U179"><span class="var type1" id="S20T49U256">U0</span>(:,:,<span class="var type1" id="S28T1U259">ii</span>)</span>+<span class="mxinfo " id="T86:U182"><span class="var type1" id="S21T49U261">U1</span>(:,:,<span class="var type1" id="S28T1U264">ii</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,33" id="srcline33">33</a></span><span class="line">        [<span class="mxinfo " id="T76:U185"><span class="var type1" id="S41T76U268">temp</span></span>, <span class="mxinfo " id="T76:U187"><span class="var type1" id="S42T76U269">btemp</span></span>]=min(<span class="mxinfo " id="T86:U189"><span class="var type1" id="S22T49U273">U</span>(:,:,<span class="var type1" id="S28T1U276">ii</span>)</span>,[],2);</span></span>
<span class="srcline"><span class="lineno"><a href="69,34" id="srcline34">34</a></span><span class="line">        <span class="mxinfo " id="T76:U192"><span class="mxinfo " id="T76:U193"><span class="var type1" id="S5T11U283">b</span>(:,<span class="var type1" id="S28T1U285">ii</span>)</span> = <span class="mxinfo " id="T76:U196"><span class="var type1" id="S42T76U287">btemp</span>-<span class="mxinfo " id="T1:U198">1</span></span></span>; <span class="mxinfo " id="T80:U199"><span class="mxinfo " id="T80:U200"><span class="var type1" id="S27T16U292">bmat</span>(<span class="var type1" id="S23T80U293">indd</span>)</span> = <span class="mxinfo " id="T80:U203"><span class="mxinfo " id="T80:U204"><span class="var type1" id="S5T11U296">b</span>(<span class="var type1" id="S25T80U297">nozeroind</span>)</span>+<span class="mxinfo " id="T1:U207">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,35" id="srcline35">35</a></span><span class="line">        <span class="mxinfo " id="T1:U208"><span class="mxinfo " id="T1:U209"><span class="var type1" id="S17T12U302">sum_U_MAP</span>(<span class="var type1" id="S36T1U303">ll</span>)</span>=<span class="mxinfo " id="T1:U212">sum(<span class="mxinfo " id="T76:U213"><span class="var type1" id="S41T76U307">temp</span>(:)</span>)</span></span>; <span class="mxinfo " id="T1:U215"><span class="mxinfo " id="T1:U216"><span class="var type1" id="S19T79U312">cri</span>(<span class="var type1" id="S28T1U313">ii</span>)</span> = <span class="mxinfo " id="T1:U219"><span class="var type1" id="S17T12U315">sum_U_MAP</span>(<span class="var type1" id="S36T1U316">ll</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,36" id="srcline36">36</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T7:U222"><span class="var type1" id="S36T1U321">ll</span>&gt;=<span class="mxinfo " id="T1:U224">3</span></span> &amp;&amp; <span class="mxinfo " id="T7:U225"><span class="mxinfo " id="T1:U226">std(<span class="mxinfo " id="T48:U227"><span class="var type1" id="S17T12U327">sum_U_MAP</span>(<span class="mxinfo " id="T98:U229"><span class="mxinfo " id="T1:U230"><span class="var type1" id="S36T1U330">ll</span>-2</span>:<span class="var type1" id="S36T1U332">ll</span></span>)</span>)</span>&lt;<span class="mxinfo " id="T1:U233">0.01</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="69,37" id="srcline37">37</a></span><span class="line">            <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,38" id="srcline38">38</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,39" id="srcline39">39</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,40" id="srcline40">40</a></span><span class="line">     <span class="mxinfo " id="T108:U234"><span class="mxinfo " id="T108:U235"><span class="var type1" id="S3T55U338">Pb</span>(:,<span class="var type1" id="S28T1U340">ii</span>,:)</span> = <span class="mxinfo " id="T109:U238">(<span class="mxinfo " id="T86:U239"><span class="mxinfo " id="T86:U240">exp(<span class="mxinfo " id="T86:U241">-<span class="mxinfo " id="T86:U242"><span class="var type1" id="S22T49U349">U</span>(:,:,<span class="var type1" id="S28T1U352">ii</span>)</span></span>)</span>./(<span class="mxinfo " id="T86:U245"><span class="mxinfo " id="T76:U246">sum(<span class="mxinfo " id="T86:U247">exp(<span class="mxinfo " id="T86:U248">-<span class="mxinfo " id="T86:U249"><span class="var type1" id="S22T49U361">U</span>(:,:,<span class="var type1" id="S28T1U364">ii</span>)</span></span>)</span>,2)</span>*<span class="mxinfo " id="T48:U252">ones(1,3)</span></span>)</span>)'</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="69,41" id="srcline41">41</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,42" id="srcline42">42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,43" id="srcline43">43</a></span><span class="line"><span class="mxinfo " id="T11:U253"><span class="var type1" id="S2T11U372">b0</span> = <span class="var type1" id="S5T11U373">b</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="69,44" id="srcline44">44</a></span><span class="line"><span class="mxinfo " id="T1:U256"><span class="var type1" id="S4T1U376">sum_U</span>=<span class="mxinfo " id="T1:U258">mean(<span class="var type1" id="S19T79U379">cri</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,45" id="srcline45">45</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="69,46" id="srcline46">46</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="69,47" id="srcline47">47</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="69,48" id="srcline48">48</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="69,49" id="srcline49">49</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="69,50" id="srcline50">50</a></span><span class="line"></span></span>
</pre>
