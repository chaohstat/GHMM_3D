<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T11U3">b0</span>, <span class="var type1" id="S3T13U4">beta0</span>, <span class="var type1" id="S4T15U5">betabar0</span>, <span class="var type1" id="S5T39U6">Sigma_s0</span>, <span class="var type1" id="S6T1U7">tau0</span>, <span class="var type1" id="S7T12U8">sum_U</span>]=SREM_EM(<span class="var type1" id="S8T11U11">b</span>,<span class="var type1" id="S9T11U12">Y1</span>,<span class="var type1" id="S10T16U13">DIC</span>,<span class="var type1" id="S11T3U14">subind1</span>,<span class="var type1" id="S12T13U15">beta</span>,<span class="var type1" id="S13T15U16">betabar</span>,<span class="var type1" id="S14T39U17">Sigma_s</span>,<span class="var type1" id="S15T1U18">tau</span>,<span class="var type1" id="S16T1U19">EM_iter</span>,<span class="var type1" id="S17T1U20">MAP_iter</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%%  The EM algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%---input---------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%   b: initial 2D or 3D labels p*n1, n1: number of pateint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%   Y1: image intensity matrix p*m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%   DIC: dictionary of spatial relationship</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">%   subind1: subject information m*(2+q)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%   beta: initial value of beta q*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">%   betabar: initial value of betabar q*2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">%   Sigma_s: initial value of variance matrix in epsilon 1*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="comment">%   tau: initial value of tau in Gibbs distribution 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="comment">%   EM_iter: maximum number of iterations of the EM algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="comment">%   MAP_iter: maximum number of iterations of the MAP algorithm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="comment">%---output--------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="comment">%   b0: final 2D or 3D labels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="comment">%   beta0: final vector of beta  q*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="comment">%   betabar0: final vector of betabar  q*2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="comment">%   Sigma_s0: final value of variance matrix in epsilon  1*p</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="comment">%   tau0: final value of tau in Gibbs distribution  1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="comment">%   sum_U: energy function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="comment">%   Copyright by Chao Huang, 2015/01/23</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo " id="T12:U17"><span class="var type1" id="S7T12U23">sum_U</span> = <span class="mxinfo " id="T12:U19">zeros(<span class="mxinfo " id="T1:U20">1</span>,<span class="var type1" id="S16T1U27">EM_iter</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="mxinfo " id="T1:U22">[<span class="var type1" id="S19T1U31">m</span>,<span class="var type1" id="S20T1U32">N1</span>] = size(<span class="var type1" id="S9T11U35">Y1</span>)</span>; <span class="mxinfo " id="T72:U26"><span class="var type1" id="S22T72U38">W1</span> = <span class="mxinfo " id="T72:U28"><span class="mxinfo " id="T3:U29"><span class="var type1" id="S11T3U41">subind1</span>(:,<span class="mxinfo " id="T7:U31"><span class="mxinfo " id="T1:U32">3</span>:<span class="mxinfo " id="T1:U33">end</span></span>)</span>'</span></span>; <span class="mxinfo " id="T73:U34"><span class="var type1" id="S24T73U49">inx1</span> = <span class="mxinfo " id="T73:U36"><span class="mxinfo " id="T79:U37"><span class="var type1" id="S11T3U52">subind1</span>(:,<span class="mxinfo " id="T1:U39">2</span>)</span>~=<span class="mxinfo " id="T1:U40">0</span></span></span>; <span class="mxinfo " id="T11:U41"><span class="var type1" id="S25T11U58">Y11</span> = <span class="mxinfo " id="T11:U43"><span class="var type1" id="S9T11U60">Y1</span>(:,<span class="var type1" id="S24T73U62">inx1</span>)</span></span>; <span class="mxinfo " id="T72:U46"><span class="var type1" id="S26T72U65">W11</span> = <span class="mxinfo " id="T72:U48"><span class="var type1" id="S22T72U67">W1</span>(:,<span class="var type1" id="S24T73U69">inx1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo " id="T55:U51"><span class="var type1" id="S27T55U72">Pb</span> = <span class="mxinfo " id="T55:U53">zeros(<span class="mxinfo " id="T1:U54">3</span>,<span class="var type1" id="S20T1U76">N1</span>,<span class="var type1" id="S19T1U77">m</span>)</span></span>; <span class="mxinfo " id="T1:U57"><span class="var type1" id="S28T1U80">N11</span> = <span class="mxinfo " id="T1:U59">length(<span class="mxinfo " id="T83:U60"><span class="var type1" id="S25T11U84">Y11</span>(<span class="mxinfo " id="T1:U62">1</span>,:)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="mxinfo " id="T1:U63"><span class="var type1" id="S30T1U89">q</span>=<span class="mxinfo " id="T1:U65">length(<span class="mxinfo " id="T93:U66"><span class="var type1" id="S12T13U93">beta</span>(:,<span class="mxinfo " id="T1:U68">1</span>)</span>)</span></span>; <span class="mxinfo " id="T74:U69"><span class="var type1" id="S31T74U98">exbetabar</span> = <span class="mxinfo " id="T74:U71">[<span class="mxinfo " id="T93:U72">zeros(<span class="var type1" id="S30T1U103">q</span>,1)</span> <span class="var type1" id="S13T15U105">betabar</span>]</span></span>;  </span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo " id="T75:U75"><span class="var type1" id="S32T75U108">unzeroDIC</span>=<span class="mxinfo " id="T75:U77"><span class="var type1" id="S10T16U110">DIC</span>~=<span class="mxinfo " id="T1:U79">0</span></span></span>; <span class="mxinfo " id="T76:U80"><span class="var type1" id="S33T76U114">sumDIC</span> = double(<span class="mxinfo " id="T76:U82">sum(<span class="var type1" id="S32T75U119">unzeroDIC</span>,2)</span>)</span>; <span class="mxinfo " id="T76:U84"><span class="var type1" id="S36T76U123">DICind</span> = <span class="mxinfo " id="T76:U86">find(<span class="mxinfo " id="T78:U87"><span class="var type1" id="S33T76U127">sumDIC</span>==<span class="mxinfo " id="T1:U89">6</span></span>)</span></span>; <span class="mxinfo " id="T11:U90"><span class="var type1" id="S38T11U131">Y11DIC</span>=<span class="mxinfo " id="T11:U92"><span class="var type1" id="S25T11U133">Y11</span>(<span class="var type1" id="S36T76U134">DICind</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S39T1U138">it</span>=<span class="mxinfo " id="T1:U96">1</span>:<span class="var type1" id="S16T1U141">EM_iter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    <span class="comment">%% E step: calculating expectations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="comment">%% update b</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">    [<span class="mxinfo " id="T11:U98"><span class="var type1" id="S40T11U145">btemp</span></span>, <span class="mxinfo " id="T55:U100"><span class="var type1" id="S41T55U146">Pb1</span></span>, <span class="mxinfo " id="T1:U102"><span class="var type1" id="S7T12U148">sum_U</span>(<span class="var type1" id="S39T1U149">it</span>)</span>] = <span class="fcn" id="F281N3:B151">SREM_MAP</span>(<span class="var type1" id="S8T11U152">b</span>,<span class="var type1" id="S25T11U153">Y11</span>,<span class="var type1" id="S10T16U154">DIC</span>,<span class="var type1" id="S26T72U155">W11</span>,<span class="var type1" id="S12T13U156">beta</span>,<span class="var type1" id="S31T74U157">exbetabar</span>,<span class="var type1" id="S14T39U158">Sigma_s</span>,<span class="var type1" id="S15T1U159">tau</span>,<span class="var type1" id="S17T1U160">MAP_iter</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="mxinfo " id="T55:U114"><span class="mxinfo " id="T55:U115"><span class="var type1" id="S27T55U164">Pb</span>(:,<span class="var type1" id="S24T73U166">inx1</span>,:)</span> = <span class="var type1" id="S41T55U168">Pb1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">    <span class="comment">%% M step: update beta, betabar, Sigma_v, Sigma_s and tau</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">    [<span class="mxinfo " id="T13:U119"><span class="var type1" id="S12T13U172">beta</span></span>, <span class="mxinfo " id="T39:U121"><span class="var type1" id="S14T39U173">Sigma_s</span></span>] = <span class="fcn" id="F536N4:B175">bSSupdate</span>(<span class="var type1" id="S9T11U176">Y1</span>,<span class="var type1" id="S27T55U177">Pb</span>,<span class="var type1" id="S22T72U178">W1</span>,<span class="var type1" id="S12T13U179">beta</span>,<span class="var type1" id="S31T74U180">exbetabar</span>,<span class="var type1" id="S30T1U181">q</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line">    <span class="comment">% update betabar</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line">    <span class="mxinfo " id="T15:U129"><span class="var type1" id="S13T15U184">betabar</span> = <span class="mxinfo " id="T15:U131"><span class="fcn" id="F570N5:B186">bbarupdate</span>(<span class="var type1" id="S25T11U187">Y11</span>,<span class="var type1" id="S41T55U188">Pb1</span>,<span class="var type1" id="S26T72U189">W11</span>,<span class="var type1" id="S12T13U190">beta</span>,<span class="var type1" id="S14T39U191">Sigma_s</span>,<span class="var type1" id="S30T1U192">q</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53">53</a></span><span class="line">    <span class="comment">% update tau</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54">54</a></span><span class="line">    <span class="mxinfo " id="T1:U138"><span class="var type1" id="S15T1U195">tau</span> = <span class="mxinfo " id="T1:U140"><span class="fcn" id="F592N10:B197">tauupdate</span>(<span class="var type1" id="S15T1U198">tau</span>,<span class="var type1" id="S40T11U199">btemp</span>,<span class="var type1" id="S38T11U200">Y11DIC</span>,<span class="var type1" id="S28T1U201">N11</span>,<span class="var type1" id="S10T16U202">DIC</span>,<span class="var type1" id="S36T76U203">DICind</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55">55</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56">56</a></span><span class="line">    <span class="mxinfo " id="T11:U147"><span class="var type1" id="S8T11U206">b</span> = <span class="var type1" id="S40T11U207">btemp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57">57</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58">58</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U150"><span class="var type1" id="S39T1U212">it</span>&gt;=<span class="mxinfo " id="T1:U152">3</span></span> &amp;&amp; <span class="mxinfo " id="T7:U153"><span class="mxinfo " id="T1:U154">std(<span class="mxinfo " id="T48:U155"><span class="var type1" id="S7T12U218">sum_U</span>(<span class="mxinfo " id="T98:U157"><span class="mxinfo " id="T1:U158"><span class="var type1" id="S39T1U221">it</span>-2</span>:<span class="var type1" id="S39T1U223">it</span></span>)</span>)</span>&lt;<span class="mxinfo " id="T1:U161">0.01</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59">59</a></span><span class="line">        <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60">60</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61">61</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62">62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63">63</a></span><span class="line"><span class="mxinfo " id="T11:U162"><span class="var type1" id="S2T11U228">b0</span> = <span class="var type1" id="S8T11U229">b</span></span>; <span class="mxinfo " id="T13:U165"><span class="var type1" id="S3T13U232">beta0</span> = <span class="var type1" id="S12T13U233">beta</span></span>; <span class="mxinfo " id="T15:U168"><span class="var type1" id="S4T15U236">betabar0</span> = <span class="var type1" id="S13T15U237">betabar</span></span>; <span class="mxinfo " id="T39:U171"><span class="var type1" id="S5T39U240">Sigma_s0</span> = <span class="var type1" id="S14T39U241">Sigma_s</span></span>; <span class="mxinfo " id="T1:U174"><span class="var type1" id="S6T1U244">tau0</span> = <span class="var type1" id="S15T1U245">tau</span></span>;</span></span>
</pre>
